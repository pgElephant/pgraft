name: Build All Packages

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
        type: string
      pg_version:
        description: 'PostgreSQL version'
        required: true
        default: '17'
        type: choice
        options:
          - '17'
          - '16'
          - '15'
          - '14'
      release:
        description: 'Release number'
        required: true
        default: '1'
        type: string

jobs:
  # Build RPM packages for all distributions
  build-rpm-centos:
    name: CentOS Stream 9
    uses: ./.github/workflows/reusable/build-rpm.yml
    with:
      version: ${{ inputs.version }}
      pg_version: ${{ inputs.pg_version }}
      release: ${{ inputs.release }}
      os_image: 'quay.io/centos/centos:stream9'
  
  build-rpm-rocky:
    name: Rocky Linux 9
    uses: ./.github/workflows/reusable/build-rpm.yml
    with:
      version: ${{ inputs.version }}
      pg_version: ${{ inputs.pg_version }}
      release: ${{ inputs.release }}
      os_image: 'rockylinux:9'
  
  build-rpm-alma:
    name: AlmaLinux 9
    uses: ./.github/workflows/reusable/build-rpm.yml
    with:
      version: ${{ inputs.version }}
      pg_version: ${{ inputs.pg_version }}
      release: ${{ inputs.release }}
      os_image: 'almalinux:9'
  
  # Build DEB packages for all distributions
  build-deb-ubuntu-22:
    name: Ubuntu 22.04
    uses: ./.github/workflows/reusable/build-deb.yml
    with:
      version: ${{ inputs.version }}
      pg_version: ${{ inputs.pg_version }}
      release: ${{ inputs.release }}
      os_image: 'ubuntu:22.04'
  
  build-deb-ubuntu-24:
    name: Ubuntu 24.04
    uses: ./.github/workflows/reusable/build-deb.yml
    with:
      version: ${{ inputs.version }}
      pg_version: ${{ inputs.pg_version }}
      release: ${{ inputs.release }}
      os_image: 'ubuntu:24.04'
  
  build-deb-debian-11:
    name: Debian 11
    uses: ./.github/workflows/reusable/build-deb.yml
    with:
      version: ${{ inputs.version }}
      pg_version: ${{ inputs.pg_version }}
      release: ${{ inputs.release }}
      os_image: 'debian:11'
  
  build-deb-debian-12:
    name: Debian 12
    uses: ./.github/workflows/reusable/build-deb.yml
    with:
      version: ${{ inputs.version }}
      pg_version: ${{ inputs.pg_version }}
      release: ${{ inputs.release }}
      os_image: 'debian:12'
  
  # Create GitHub Release with all packages
  create-release:
    name: Create GitHub Release
    needs: 
      - build-rpm-centos
      - build-rpm-rocky
      - build-rpm-alma
      - build-deb-ubuntu-22
      - build-deb-ubuntu-24
      - build-deb-debian-11
      - build-deb-debian-12
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: packages
      
      - name: Display structure
        run: |
          echo "ðŸ“¦ Downloaded packages:"
          find packages -type f -name "*.rpm" -o -name "*.deb" | sort
          echo
          echo "ðŸ“Š Package count:"
          echo "  RPM: $(find packages -name "*.rpm" | wc -l)"
          echo "  DEB: $(find packages -name "*.deb" | wc -l)"
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ inputs.version }}-pg${{ inputs.pg_version }}
          name: pgraft ${{ inputs.version }} for PostgreSQL ${{ inputs.pg_version }}
          body: |
            # pgraft ${{ inputs.version }} for PostgreSQL ${{ inputs.pg_version }}
            
            ## ðŸ“¦ Distribution Packages
            
            ### RPM Packages (Red Hat Enterprise Linux 9 compatible)
            - CentOS Stream 9
            - Rocky Linux 9
            - AlmaLinux 9
            
            ### DEB Packages (Debian/Ubuntu)
            - Ubuntu 22.04 LTS (Jammy)
            - Ubuntu 24.04 LTS (Noble)
            - Debian 11 (Bullseye)
            - Debian 12 (Bookworm)
            
            ## ðŸš€ Installation
            
            ### RPM-based systems
            ```bash
            sudo rpm -ivh pgraft-${{ inputs.version }}-${{ inputs.release }}.*.rpm
            ```
            
            ### DEB-based systems
            ```bash
            sudo dpkg -i postgresql-${{ inputs.pg_version }}-pgraft_${{ inputs.version }}-${{ inputs.release }}_*.deb
            sudo apt-get install -f
            ```
            
            ## ðŸ“š Documentation
            
            - [Installation Guide](https://github.com/pgElephant/pgraft#installation)
            - [Quick Start](https://github.com/pgElephant/pgraft#quick-start)
            - [API Reference](https://github.com/pgElephant/pgraft/blob/main/docs/api.md)
          draft: false
          prerelease: false
          files: |
            packages/**/*.rpm
            packages/**/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

